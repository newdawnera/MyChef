// app/(tabs)/saved.tsx
/**
 * Saved Recipes Screen with Filters
 *
 * Features:
 * - Real data from Firebase + AsyncStorage
 * - Filter by: All, Favorites, Cooked, Uncooked
 * - Search functionality
 * - Pull-to-refresh
 * - Optimistic UI updates
 */

import React, { useState } from "react";
import {
  View,
  Text,
  Image,
  TextInput,
  TouchableOpacity,
  ScrollView,
  StatusBar,
  ActivityIndicator,
  RefreshControl,
} from "react-native";
import { SafeAreaView } from "react-native-safe-area-context";
import {
  ArrowLeft,
  Search,
  Clock,
  Flame,
  Heart,
  ChefHat,
  Bookmark,
  Filter,
  Users,
} from "lucide-react-native";
import { useRouter, useLocalSearchParams } from "expo-router";
import { useTheme } from "@/contexts/ThemeContext";
import { useSavedRecipes } from "@/contexts/SavedRecipesContext";

type FilterType = "all" | "favorites" | "cooked" | "uncooked";

export default function SavedRecipesScreen() {
  const router = useRouter();
  const params = useLocalSearchParams();
  const { colors, theme } = useTheme();
  const { savedRecipes, loading, syncing, toggleFavorite, unsaveRecipe } =
    useSavedRecipes();

  const [search, setSearch] = useState("");
  const [activeFilter, setActiveFilter] = useState<FilterType>(
    (params.filter as FilterType) || "all"
  );
  const [refreshing, setRefreshing] = useState(false);

  /**
   * Handle pull-to-refresh
   */
  const onRefresh = async () => {
    setRefreshing(true);
    // The context will automatically sync with Firebase
    // Just wait a moment for the sync to complete
    setTimeout(() => setRefreshing(false), 1000);
  };

  /**
   * Apply filters
   */
  const getFilteredRecipes = () => {
    let filtered = savedRecipes;

    // Apply category filter
    switch (activeFilter) {
      case "favorites":
        filtered = filtered.filter((r) => r.isFavorite);
        break;
      case "cooked":
        filtered = filtered.filter((r) => r.isCooked);
        break;
      case "uncooked":
        filtered = filtered.filter((r) => !r.isCooked);
        break;
      default:
        break;
    }

    // Apply search filter
    if (search) {
      filtered = filtered.filter((r) =>
        r.recipe.title.toLowerCase().includes(search.toLowerCase())
      );
    }

    // Sort by savedAt (most recent first)
    return filtered.sort((a, b) => b.savedAt - a.savedAt);
  };

  const filteredRecipes = getFilteredRecipes();

  /**
   * Get filter button config
   */
  const getFilterConfig = (filter: FilterType) => {
    const isActive = activeFilter === filter;
    const configs = {
      all: { label: "All", icon: Bookmark },
      favorites: { label: "Favorites", icon: Heart },
      cooked: { label: "Cooked", icon: ChefHat },
      uncooked: { label: "To Cook", icon: Clock },
    };
    return { ...configs[filter], isActive };
  };

  /**
   * Handle recipe card press
   */
  const handleRecipePress = (recipeId: number) => {
    router.push(`/recipes/details?id=${recipeId}`);
  };

  /**
   * Handle favorite toggle
   */
  const handleToggleFavorite = async (recipeId: number) => {
    await toggleFavorite(recipeId);
  };

  /**
   * Render empty state
   */
  const renderEmptyState = () => {
    const messages = {
      all: {
        title: "No Saved Recipes",
        message:
          "Start saving recipes you love and they'll appear here for easy access!",
        icon: Bookmark,
      },
      favorites: {
        title: "No Favorites Yet",
        message: "Mark recipes as favorites by tapping the heart icon!",
        icon: Heart,
      },
      cooked: {
        title: "No Cooked Recipes",
        message:
          "Start cooking and mark recipes as cooked to track your progress!",
        icon: ChefHat,
      },
      uncooked: {
        title: "All Recipes Cooked!",
        message: "Great job! You've cooked all your saved recipes.",
        icon: ChefHat,
      },
    };

    const config = messages[activeFilter];
    const Icon = config.icon;

    return (
      <View
        style={{
          flex: 1,
          justifyContent: "center",
          alignItems: "center",
          paddingHorizontal: 40,
          paddingTop: 60,
        }}
      >
        <View
          style={{
            width: 80,
            height: 80,
            borderRadius: 40,
            backgroundColor: `${colors.primary}15`,
            alignItems: "center",
            justifyContent: "center",
            marginBottom: 20,
          }}
        >
          <Icon size={36} color={colors.primary} />
        </View>
        <Text
          style={{
            fontSize: 20,
            fontWeight: "700",
            color: colors.textPrimary,
            marginBottom: 8,
            textAlign: "center",
          }}
        >
          {config.title}
        </Text>
        <Text
          style={{
            fontSize: 15,
            color: colors.textSecondary,
            textAlign: "center",
            lineHeight: 22,
          }}
        >
          {config.message}
        </Text>

        {activeFilter === "all" && (
          <TouchableOpacity
            style={{
              marginTop: 24,
              backgroundColor: colors.primary,
              paddingHorizontal: 24,
              paddingVertical: 14,
              borderRadius: 12,
            }}
            onPress={() => router.push("/(tabs)")}
          >
            <Text
              style={{
                fontSize: 15,
                fontWeight: "600",
                color: "#FFFFFF",
              }}
            >
              Discover Recipes
            </Text>
          </TouchableOpacity>
        )}
      </View>
    );
  };

  /**
   * Render loading state
   */
  if (loading) {
    return (
      <SafeAreaView
        style={{ flex: 1, backgroundColor: colors.background }}
        edges={["top"]}
      >
        <StatusBar
          barStyle={theme === "dark" ? "light-content" : "dark-content"}
        />
        <View
          style={{
            flex: 1,
            justifyContent: "center",
            alignItems: "center",
          }}
        >
          <ActivityIndicator size="large" color={colors.primary} />
          <Text
            style={{
              marginTop: 16,
              fontSize: 15,
              color: colors.textSecondary,
            }}
          >
            Loading saved recipes...
          </Text>
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView
      style={{ flex: 1, backgroundColor: colors.cardBg }}
      edges={["top"]}
    >
      <StatusBar
        barStyle={theme === "dark" ? "light-content" : "dark-content"}
      />

      {/* Header */}
      <View
        style={{
          paddingVertical: 16,
          paddingTop: 24,
          paddingHorizontal: 20,
          backgroundColor: colors.cardBg,
          shadowColor: colors.shadow,
          shadowOpacity: 0.05,
          shadowRadius: 4,
          shadowOffset: { width: 0, height: 2 },
          elevation: 2,
          zIndex: 10,
        }}
      >
        <View
          style={{
            flexDirection: "row",
            alignItems: "center",
            justifyContent: "space-between",
            marginBottom: 16,
          }}
        >
          <View style={{ flexDirection: "row", alignItems: "center", gap: 12 }}>
            {/* --- INSERT THIS BUTTON START --- */}
            <TouchableOpacity
              onPress={() => router.back()}
              style={{
                width: 40,
                height: 40,
                borderRadius: 20,
                backgroundColor: colors.background,
                alignItems: "center",
                justifyContent: "center",
                borderWidth: 1,
                borderColor: colors.border,
              }}
            >
              <ArrowLeft size={20} color={colors.textPrimary} />
            </TouchableOpacity>
            {/* --- INSERT THIS BUTTON END --- */}

            <Text
              style={{
                fontSize: 24,
                fontWeight: "700",
                color: colors.textPrimary,
              }}
            >
              Saved Recipes
            </Text>
            {syncing && (
              <ActivityIndicator size="small" color={colors.primary} />
            )}
          </View>

          {/* <View
            style={{
              backgroundColor: `${colors.primary}15`,
              paddingHorizontal: 12,
              paddingVertical: 6,
              borderRadius: 12,
            }}
          >
            <Text
              style={{
                fontSize: 14,
                fontWeight: "600",
                color: colors.primary,
              }}
            >
              {savedRecipes.length}
            </Text>
          </View> */}
        </View>

        {/* Search Bar */}
        <View style={{ position: "relative", marginBottom: 16 }}>
          <View
            style={{
              position: "absolute",
              left: 16,
              top: "50%",
              transform: [{ translateY: -10 }],
              zIndex: 1,
            }}
          >
            <Search size={20} color={colors.textSecondary} />
          </View>
          <TextInput
            placeholder="Search saved recipes..."
            placeholderTextColor={colors.textTertiary}
            value={search}
            onChangeText={setSearch}
            style={{
              backgroundColor: colors.background,
              borderRadius: 20,
              paddingVertical: 14,
              paddingHorizontal: 16,
              paddingLeft: 48,
              fontSize: 15,
              borderWidth: 1,
              borderColor: colors.border,
              color: colors.textPrimary,
            }}
          />
        </View>

        {/* Filter Tabs */}
        <ScrollView
          horizontal
          showsHorizontalScrollIndicator={false}
          contentContainerStyle={{ gap: 8 }}
        >
          {(["all", "favorites", "cooked", "uncooked"] as FilterType[]).map(
            (filter) => {
              const config = getFilterConfig(filter);
              const Icon = config.icon;

              return (
                <TouchableOpacity
                  key={filter}
                  onPress={() => setActiveFilter(filter)}
                  style={{
                    flexDirection: "row",
                    alignItems: "center",
                    gap: 6,
                    paddingHorizontal: 14,
                    paddingVertical: 10,
                    borderRadius: 20,
                    backgroundColor: config.isActive
                      ? colors.primary
                      : colors.background,
                    borderWidth: 1,
                    borderColor: config.isActive
                      ? colors.primary
                      : colors.border,
                  }}
                >
                  <Icon
                    size={14}
                    color={config.isActive ? "#FFFFFF" : colors.textSecondary}
                  />
                  <Text
                    style={{
                      fontSize: 12,
                      fontWeight: "500",
                      color: config.isActive ? "#FFFFFF" : colors.textSecondary,
                    }}
                  >
                    {config.label}
                  </Text>
                </TouchableOpacity>
              );
            }
          )}
        </ScrollView>
      </View>

      {/* Recipe Grid */}
      <View style={{ flex: 1, backgroundColor: colors.background }}>
        {filteredRecipes.length === 0 ? (
          renderEmptyState()
        ) : (
          <ScrollView
            showsVerticalScrollIndicator={false}
            refreshControl={
              <RefreshControl
                refreshing={refreshing}
                onRefresh={onRefresh}
                tintColor={colors.primary}
                colors={[colors.primary]}
              />
            }
            contentContainerStyle={{
              paddingBottom: 120,
              paddingTop: 8,
            }}
          >
            <View style={{ paddingHorizontal: 20, paddingVertical: 20 }}>
              {/* Count */}
              <Text
                style={{
                  fontSize: 14,
                  color: colors.textSecondary,
                  marginBottom: 20,
                }}
              >
                {search ? "Showing " : ""}
                <Text style={{ color: colors.primary, fontWeight: "600" }}>
                  {filteredRecipes.length}
                </Text>
                {search
                  ? " matching recipes"
                  : activeFilter === "all"
                  ? " saved recipes"
                  : ` ${activeFilter} recipes`}
              </Text>

              {/* Grid */}
              <View
                style={{
                  flexDirection: "row",
                  flexWrap: "wrap",
                  justifyContent: "space-between",
                }}
              >
                {filteredRecipes.map((entry) => (
                  <TouchableOpacity
                    key={entry.recipe.id}
                    style={{
                      width: "48%",
                      marginBottom: 16,
                      backgroundColor: colors.cardBg,
                      borderRadius: 20,
                      overflow: "hidden",
                      borderWidth: 1,
                      borderColor: colors.border,
                      shadowColor: colors.shadow,
                      shadowOpacity: 0.05,
                      shadowRadius: 8,
                      shadowOffset: { width: 0, height: 2 },
                      elevation: 2,
                    }}
                    onPress={() => handleRecipePress(entry.recipe.id)}
                  >
                    {/* Image */}
                    <View style={{ height: 160, position: "relative" }}>
                      <Image
                        source={{ uri: entry.recipe.image }}
                        style={{ width: "100%", height: "100%" }}
                        resizeMode="cover"
                      />

                      {/* Heart Icon */}
                      <TouchableOpacity
                        onPress={() => handleToggleFavorite(entry.recipe.id)}
                        style={{
                          position: "absolute",
                          top: 8,
                          right: 8,
                          width: 32,
                          height: 32,
                          borderRadius: 16,
                          backgroundColor: "rgba(255, 255, 255, 0.95)",
                          alignItems: "center",
                          justifyContent: "center",
                          shadowColor: "#000",
                          shadowOpacity: 0.1,
                          shadowRadius: 4,
                          shadowOffset: { width: 0, height: 2 },
                          elevation: 2,
                        }}
                      >
                        <Heart
                          size={16}
                          color={entry.isFavorite ? "#FF6B6B" : "#9CA3AF"}
                          fill={entry.isFavorite ? "#FF6B6B" : "transparent"}
                        />
                      </TouchableOpacity>

                      {/* Cooked Badge */}
                      {entry.isCooked && (
                        <View
                          style={{
                            position: "absolute",
                            bottom: 8,
                            left: 8,
                            backgroundColor: "rgba(112, 173, 71, 0.95)",
                            borderRadius: 12,
                            paddingHorizontal: 8,
                            paddingVertical: 4,
                            flexDirection: "row",
                            alignItems: "center",
                            gap: 4,
                          }}
                        >
                          <ChefHat size={12} color="#FFFFFF" />
                          <Text
                            style={{
                              fontSize: 10,
                              color: "#FFFFFF",
                              fontWeight: "600",
                            }}
                          >
                            Cooked
                          </Text>
                        </View>
                      )}
                    </View>

                    {/* Content */}
                    <View style={{ padding: 12 }}>
                      <Text
                        numberOfLines={2}
                        style={{
                          fontSize: 14,
                          fontWeight: "600",
                          color: colors.textPrimary,
                          marginBottom: 8,
                          lineHeight: 18,
                        }}
                      >
                        {entry.recipe.title}
                      </Text>

                      <View
                        style={{
                          flexDirection: "row",
                          justifyContent: "space-between",
                        }}
                      >
                        <View
                          style={{
                            flexDirection: "row",
                            alignItems: "center",
                            gap: 4,
                          }}
                        >
                          <Clock size={12} color={colors.textSecondary} />
                          <Text
                            style={{
                              fontSize: 12,
                              color: colors.textSecondary,
                            }}
                          >
                            {entry.recipe.readyInMinutes} min
                          </Text>
                        </View>
                        <View
                          style={{
                            flexDirection: "row",
                            alignItems: "center",
                            gap: 4,
                          }}
                        >
                          <Users size={12} color={colors.textSecondary} />
                          <Text
                            style={{
                              fontSize: 12,
                              color: colors.textSecondary,
                            }}
                          >
                            {entry.recipe.servings}
                          </Text>
                        </View>
                      </View>
                    </View>
                  </TouchableOpacity>
                ))}
              </View>
            </View>
          </ScrollView>
        )}
      </View>
    </SafeAreaView>
  );
}
