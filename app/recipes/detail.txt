// app/recipes/details.tsx - ENHANCED WITH SAVE, FAVORITE & SHARE
/**
 * Enhanced features:
 * 1. Save/Unsave recipe (bookmark icon)
 * 2. Favorite recipe (heart icon)
 * 3. Share recipe functionality (works for non-users)
 * 4. Mark as cooked functionality
 * 5. All previous animations and tooltips preserved
 */

import React, { useState, useEffect, useRef } from "react";
import {
  View,
  Text,
  Image,
  ScrollView,
  TouchableOpacity,
  StatusBar,
  ActivityIndicator,
  Alert,
  Animated,
  Pressable,
  Share,
  Platform,
  Dimensions,
} from "react-native";
import {
  SafeAreaView,
  useSafeAreaInsets,
} from "react-native-safe-area-context";
import {
  ArrowLeft,
  Heart,
  Share2,
  Clock,
  Flame,
  Users,
  ChefHat,
  Bookmark,
  BookmarkCheck,
} from "lucide-react-native";
import { useRouter, useLocalSearchParams } from "expo-router";
import ConfettiCannon from "react-native-confetti-cannon";

import { useTheme } from "@/contexts/ThemeContext";
import { useRecentRecipes } from "@/hooks/useRecentRecipes";
import { useSavedRecipes } from "@/contexts/SavedRecipesContext";
import { getRecipeDetails } from "@/services/spoonacularServices";
import { SpoonacularRecipe, calculateDifficulty } from "@/types/recipe";

// Tooltip Component for Meta Icons
interface TooltipProps {
  visible: boolean;
  label: string;
  color?: string;
}

const Tooltip: React.FC<TooltipProps> = ({
  visible,
  label,
  color = "#70AD47",
}) => {
  const fadeAnim = useRef(new Animated.Value(0)).current;
  const scaleAnim = useRef(new Animated.Value(0.8)).current;

  useEffect(() => {
    if (visible) {
      Animated.parallel([
        Animated.timing(fadeAnim, {
          toValue: 1,
          duration: 200,
          useNativeDriver: true,
        }),
        Animated.spring(scaleAnim, {
          toValue: 1,
          friction: 8,
          tension: 100,
          useNativeDriver: true,
        }),
      ]).start();
    } else {
      Animated.parallel([
        Animated.timing(fadeAnim, {
          toValue: 0,
          duration: 150,
          useNativeDriver: true,
        }),
        Animated.timing(scaleAnim, {
          toValue: 0.8,
          duration: 150,
          useNativeDriver: true,
        }),
      ]).start();
    }
  }, [visible]);

  if (!visible) return null;

  return (
    <Animated.View
      style={{
        position: "absolute",
        bottom: "150%",
        left: "50%",
        transform: [{ translateX: -50 }, { scale: scaleAnim }],
        opacity: fadeAnim,
        backgroundColor: color,
        paddingHorizontal: 14,
        paddingVertical: 8,
        borderRadius: 10,
        shadowColor: "#000",
        shadowOffset: { width: 0, height: 3 },
        shadowOpacity: 0.3,
        shadowRadius: 6,
        elevation: 6,
        zIndex: 1000,
        minWidth: 100,
        maxWidth: 160,
      }}
    >
      <Text
        style={{
          color: "#FFFFFF",
          fontSize: 13,
          fontWeight: "600",
          textAlign: "center",
          flexWrap: "wrap",
        }}
      >
        {label}
      </Text>
      {/* Tooltip Arrow */}
      <View
        style={{
          position: "absolute",
          bottom: -5,
          left: "50%",
          marginLeft: -5,
          width: 10,
          height: 10,
          backgroundColor: color,
          transform: [{ rotate: "45deg" }],
        }}
      />
    </Animated.View>
  );
};

// Meta Info Item with Tooltip
interface MetaItemProps {
  icon: any;
  value: string;
  label: string;
  color: string;
}

const MetaItem: React.FC<MetaItemProps> = ({
  icon: Icon,
  value,
  label,
  color,
}) => {
  const [showTooltip, setShowTooltip] = useState(false);
  const scaleAnim = useRef(new Animated.Value(1)).current;
  const timeoutRef = useRef<number | null>(null);

  const handlePressIn = () => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }

    setShowTooltip(true);
    Animated.spring(scaleAnim, {
      toValue: 1.15,
      friction: 4,
      tension: 80,
      useNativeDriver: true,
    }).start();
  };

  const handlePressOut = () => {
    timeoutRef.current = setTimeout(() => {
      setShowTooltip(false);
    }, 3000);

    Animated.spring(scaleAnim, {
      toValue: 1,
      friction: 4,
      tension: 80,
      useNativeDriver: true,
    }).start();
  };

  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  return (
    <Pressable
      onPressIn={handlePressIn}
      onPressOut={handlePressOut}
      style={{
        position: "relative",
        alignItems: "center",
        backgroundColor: "rgba(112, 173, 71, 0.08)",
        paddingHorizontal: 12,
        paddingVertical: 8,
        borderRadius: 12,
        borderWidth: 1,
        borderColor: "rgba(112, 173, 71, 0.15)",
      }}
    >
      <Tooltip visible={showTooltip} label={label} color={color} />
      <Animated.View
        style={{
          flexDirection: "row",
          alignItems: "center",
          gap: 6,
          transform: [{ scale: scaleAnim }],
        }}
      >
        <Icon size={18} color={color} />
        <Text style={{ fontSize: 14, color: color, fontWeight: "600" }}>
          {value}
        </Text>
      </Animated.View>
    </Pressable>
  );
};

export default function RecipeDetailsScreen() {
  const router = useRouter();
  const params = useLocalSearchParams();
  const { colors, theme } = useTheme();
  const { bottom } = useSafeAreaInsets();
  const windowWidth = Dimensions.get("window").width;

  // Get contexts
  const { addRecentRecipe } = useRecentRecipes();
  const {
    isSaved: checkIsSaved,
    isFavorite: checkIsFavorite,
    isCooked: checkIsCooked,
    saveRecipe,
    unsaveRecipe,
    toggleFavorite,
    markAsCooked,
    unmarkAsCooked,
    savedRecipes,
  } = useSavedRecipes();

  // State
  const [recipe, setRecipe] = useState<SpoonacularRecipe | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isSaved, setIsSaved] = useState(false);
  const [isFavorite, setIsFavorite] = useState(false);
  const [isCooked, setIsCooked] = useState(false);
  const [activeTab, setActiveTab] = useState<"ingredients" | "instructions">(
    "ingredients"
  );

  // Confetti Ref
  const confettiRef = useRef<ConfettiCannon>(null);

  // Animation values
  const scrollY = useRef(new Animated.Value(0)).current;
  const headerOpacity = useRef(new Animated.Value(0)).current;
  const slideAnim = useRef(new Animated.Value(0)).current;
  const fadeAnim = useRef(new Animated.Value(1)).current;

  // Title Opacity Animation (Fades out as you scroll up)
  const titleOpacity = scrollY.interpolate({
    inputRange: [0, 120],
    outputRange: [1, 0],
    extrapolate: "clamp",
  });

  // Extract recipe ID from params
  const recipeId = params.id
    ? parseInt(params.id as string, 10)
    : params.recipeId
    ? parseInt(params.recipeId as string, 10)
    : null;

  useEffect(() => {
    if (recipeId) {
      fetchRecipe();
    } else {
      setError("No recipe ID provided");
      setLoading(false);
    }
  }, [recipeId]);

  // Update saved/favorite/cooked status when recipe loads OR when savedRecipes changes
  useEffect(() => {
    if (recipe) {
      const savedStatus = checkIsSaved(recipe.id);
      const favoriteStatus = checkIsFavorite(recipe.id);
      const cookedStatus = checkIsCooked(recipe.id);

      setIsSaved(savedStatus);
      setIsFavorite(favoriteStatus);
      setIsCooked(cookedStatus);
    }
  }, [recipe?.id, savedRecipes]);

  const fetchRecipe = async () => {
    if (!recipeId) return;

    try {
      setLoading(true);
      setError(null);
      console.log("ðŸ” Fetching recipe details for ID:", recipeId);

      const data = await getRecipeDetails(recipeId);
      setRecipe(data);

      // Add to recent recipes
      await addRecentRecipe(data);

      console.log("âœ… Recipe loaded:", data.title);
    } catch (err: any) {
      console.error("âŒ Failed to fetch recipe:", err);
      setError(err.message || "Failed to load recipe");
    } finally {
      setLoading(false);
    }
  };

  /**
   * Handle save/unsave recipe
   */
  const handleSaveToggle = async () => {
    if (!recipe) return;

    // Optimistic update
    const newState = !isSaved;
    setIsSaved(newState);

    try {
      if (newState) {
        await saveRecipe(recipe);
      } else {
        await unsaveRecipe(recipe.id);
      }
    } catch (error) {
      // Revert on error
      setIsSaved(!newState);
      console.error("Failed to toggle save:", error);
      Alert.alert("Error", "Failed to save recipe. Please try again.");
    }
  };

  /**
   * Handle favorite toggle
   */
  const handleFavoriteToggle = async () => {
    if (!recipe) return;

    // Optimistic update
    const newFavState = !isFavorite;
    setIsFavorite(newFavState);

    // If becoming favorite, it must be saved
    const wasSaved = isSaved;
    if (newFavState && !wasSaved) {
      setIsSaved(true);
    }

    try {
      if (!wasSaved && newFavState) {
        // Save as favorite
        await saveRecipe(recipe, true);
      } else {
        // Just toggle favorite status
        await toggleFavorite(recipe.id);
      }
    } catch (error) {
      // Revert on error
      setIsFavorite(!newFavState);
      if (!wasSaved) setIsSaved(false);
      console.error("Failed to toggle favorite:", error);
      Alert.alert("Error", "Failed to favorite recipe. Please try again.");
    }
  };

  /**
   * Handle share recipe
   */
  const handleShare = async () => {
    if (!recipe) return;
    try {
      const message = `Check out this recipe: ${recipe.title}\n\n${recipe.spoonacularSourceUrl}`;
      await Share.share({
        message,
        title: recipe.title,
        url: recipe.spoonacularSourceUrl,
      });
    } catch (error) {
      Alert.alert("Error", "Failed to share recipe");
    }
  };

  /**
   * Handle mark as cooked
   */
  const handleMarkAsCooked = async () => {
    if (!recipe) return;

    const newCookedState = !isCooked;
    const originallySaved = isSaved;

    // Optimistic UI update
    setIsCooked(newCookedState);
    if (newCookedState && !originallySaved) {
      setIsSaved(true);
    }

    // Trigger confetti and alert for marking as cooked
    if (newCookedState) {
      setTimeout(() => {
        confettiRef.current?.start();
      }, 100);

      setTimeout(() => {
        Alert.alert(
          "Congratulations! ðŸŽ‰",
          "Recipe marked as cooked. Great job!",
          [{ text: "OK" }]
        );
      }, 600);
    }

    try {
      if (newCookedState) {
        if (!originallySaved) {
          // ATOMIC SAVE: Save with cooked status in one call - no race condition
          await saveRecipe(recipe, isFavorite, true);
        } else {
          // Already saved, just update cooked status
          await markAsCooked(recipe.id);
        }
      } else {
        // Unmark as cooked
        await unmarkAsCooked(recipe.id);
      }

      console.log("âœ… Recipe cooked status updated successfully");
    } catch (error) {
      // Revert on error
      setIsCooked(!newCookedState);
      if (!originallySaved) setIsSaved(false);
      console.error("Failed to mark as cooked:", error);
      Alert.alert("Error", "Failed to update recipe. Please try again.");
    }
  };

  // Handle tab change with slide animation
  const handleTabChange = (tab: "ingredients" | "instructions") => {
    if (tab === activeTab) return;

    const slideDirection = tab === "instructions" ? -1 : 1;

    Animated.parallel([
      Animated.timing(slideAnim, {
        toValue: slideDirection * 50,
        duration: 200,
        useNativeDriver: true,
      }),
      Animated.timing(fadeAnim, {
        toValue: 0,
        duration: 200,
        useNativeDriver: true,
      }),
    ]).start(() => {
      setActiveTab(tab);
      Animated.parallel([
        Animated.timing(slideAnim, {
          toValue: 0,
          duration: 250,
          useNativeDriver: true,
        }),
        Animated.timing(fadeAnim, {
          toValue: 1,
          duration: 250,
          useNativeDriver: true,
        }),
      ]).start();
    });
  };

  // Parallax image zoom effect
  const imageScale = scrollY.interpolate({
    inputRange: [-200, 0],
    outputRange: [1.8, 1],
    extrapolate: "clamp",
  });

  const imageTranslateY = scrollY.interpolate({
    inputRange: [-200, 0, 200],
    outputRange: [-50, 0, 100],
    extrapolate: "clamp",
  });

  // Header fade in
  scrollY.addListener(({ value }) => {
    const opacity = value > 100 ? 1 : value / 100;
    headerOpacity.setValue(opacity);
  });

  if (loading) {
    return (
      <View
        style={{
          flex: 1,
          backgroundColor: colors.background,
          justifyContent: "center",
          alignItems: "center",
        }}
      >
        <ActivityIndicator size="large" color={colors.primary} />
        <Text
          style={{
            marginTop: 16,
            fontSize: 16,
            color: colors.textSecondary,
          }}
        >
          Loading recipe...
        </Text>
      </View>
    );
  }

  if (error || !recipe) {
    return (
      <View
        style={{
          flex: 1,
          backgroundColor: colors.background,
          justifyContent: "center",
          alignItems: "center",
          paddingHorizontal: 40,
        }}
      >
        <Text
          style={{
            fontSize: 18,
            fontWeight: "600",
            color: colors.textPrimary,
            marginBottom: 8,
          }}
        >
          Failed to Load Recipe
        </Text>
        <Text
          style={{
            fontSize: 15,
            color: colors.textSecondary,
            textAlign: "center",
            marginBottom: 24,
          }}
        >
          {error || "Recipe not found"}
        </Text>
        <TouchableOpacity
          onPress={() => router.back()}
          style={{
            backgroundColor: colors.primary,
            paddingHorizontal: 24,
            paddingVertical: 12,
            borderRadius: 12,
          }}
        >
          <Text style={{ color: "#FFFFFF", fontWeight: "600" }}>Go Back</Text>
        </TouchableOpacity>
      </View>
    );
  }

  const difficulty = calculateDifficulty(recipe);

  return (
    <View style={{ flex: 1, backgroundColor: colors.background }}>
      <StatusBar
        barStyle={theme === "dark" ? "light-content" : "dark-content"}
      />

      {/* Confetti Cannon - Placed absolutely over everything */}
      <View
        pointerEvents="none"
        style={{
          position: "absolute",
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          zIndex: 9999,
        }}
      >
        <ConfettiCannon
          ref={confettiRef}
          count={200}
          origin={{ x: windowWidth / 2, y: -20 }}
          autoStart={false}
          fadeOut={true}
          fallSpeed={3000}
          explosionSpeed={350}
        />
      </View>

      {/* Floating Header (appears on scroll) with extended background */}
      <Animated.View
        style={{
          position: "absolute",
          top: 0,
          left: 0,
          right: 0,
          zIndex: 100,
          opacity: headerOpacity,
        }}
      >
        <SafeAreaView
          edges={["top"]}
          style={{ backgroundColor: colors.cardBg }}
        >
          <View
            style={{
              backgroundColor: colors.cardBg,
              paddingHorizontal: 20,
              paddingVertical: 16,
              shadowColor: "#000",
              shadowOpacity: 0.1,
              shadowRadius: 8,
              shadowOffset: { width: 0, height: 2 },
              elevation: 4,
            }}
          >
            <View
              style={{
                flexDirection: "row",
                alignItems: "center",
                justifyContent: "space-between",
              }}
            >
              <TouchableOpacity
                onPress={() => router.back()}
                style={{
                  width: 40,
                  height: 40,
                  borderRadius: 20,
                  backgroundColor: colors.background,
                  alignItems: "center",
                  justifyContent: "center",
                }}
              >
                <ArrowLeft size={20} color={colors.textPrimary} />
              </TouchableOpacity>

              <Text
                numberOfLines={1}
                style={{
                  flex: 1,
                  marginHorizontal: 12,
                  fontSize: 16,
                  fontWeight: "600",
                  color: colors.textPrimary,
                }}
              >
                {recipe.title}
              </Text>

              <View style={{ flexDirection: "row", gap: 8 }}>
                <TouchableOpacity
                  onPress={handleSaveToggle}
                  style={{
                    width: 40,
                    height: 40,
                    borderRadius: 20,
                    backgroundColor: colors.background,
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                >
                  {isSaved ? (
                    <BookmarkCheck size={20} color={colors.primary} />
                  ) : (
                    <Bookmark size={20} color={colors.textSecondary} />
                  )}
                </TouchableOpacity>

                <TouchableOpacity
                  onPress={handleFavoriteToggle}
                  style={{
                    width: 40,
                    height: 40,
                    borderRadius: 20,
                    backgroundColor: colors.background,
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                >
                  <Heart
                    size={20}
                    color={isFavorite ? "#FF6B6B" : colors.textSecondary}
                    fill={isFavorite ? "#FF6B6B" : "transparent"}
                  />
                </TouchableOpacity>

                <TouchableOpacity
                  onPress={handleShare}
                  style={{
                    width: 40,
                    height: 40,
                    borderRadius: 20,
                    backgroundColor: colors.background,
                    alignItems: "center",
                    justifyContent: "center",
                  }}
                >
                  <Share2 size={20} color={colors.textSecondary} />
                </TouchableOpacity>
              </View>
            </View>
          </View>
        </SafeAreaView>
      </Animated.View>

      <Animated.ScrollView
        showsVerticalScrollIndicator={false}
        onScroll={Animated.event(
          [{ nativeEvent: { contentOffset: { y: scrollY } } }],
          { useNativeDriver: false }
        )}
        scrollEventThrottle={16}
      >
        {/* Hero Image with Parallax */}
        <View style={{ height: 400, overflow: "hidden" }}>
          <Animated.Image
            source={{ uri: recipe.image }}
            style={{
              width: "100%",
              height: "100%",
              transform: [
                { scale: imageScale },
                { translateY: imageTranslateY },
              ],
            }}
            resizeMode="cover"
          />

          {/* Dark Gradient Overlay */}
          <View
            style={{
              position: "absolute",
              bottom: 0,
              left: 0,
              right: 0,
              height: 200,
              backgroundColor: "transparent",
            }}
            pointerEvents="none"
          >
            <View
              style={{
                flex: 1,
                backgroundColor: "rgba(0, 0, 0, 0)",
              }}
            >
              {/* Gradient effect using multiple layers */}
              <View
                style={{
                  position: "absolute",
                  bottom: 0,
                  left: 0,
                  right: 0,
                  height: 150,
                  backgroundColor: "rgba(0, 0, 0, 0.4)",
                }}
              />
            </View>
          </View>

          {/* Recipe Title on Dark Overlay */}
          <Animated.View
            style={{
              position: "absolute",
              bottom: 60,
              left: 20,
              right: 20,
              opacity: titleOpacity,
            }}
            pointerEvents="none"
          >
            <Text
              numberOfLines={2}
              style={{
                fontSize: 28,
                fontWeight: "700",
                color: "#FFFFFF",
                lineHeight: 36,
                textShadowColor: "rgba(0, 0, 0, 0.75)",
                textShadowOffset: { width: 0, height: 2 },
                textShadowRadius: 8,
              }}
            >
              {recipe.title}
            </Text>
          </Animated.View>

          {/* Top Action Buttons (initial state) */}
          <SafeAreaView
            edges={["top"]}
            style={{
              position: "absolute",
              top: 0,
              left: 0,
              right: 0,
              paddingHorizontal: 20,
              paddingTop: 10,
            }}
          >
            <View
              style={{
                flexDirection: "row",
                justifyContent: "space-between",
                alignItems: "center",
              }}
            >
              <TouchableOpacity
                onPress={() => router.back()}
                style={{
                  width: 40,
                  height: 40,
                  borderRadius: 20,
                  backgroundColor: "rgba(255, 255, 255, 0.95)",
                  alignItems: "center",
                  justifyContent: "center",
                  shadowColor: "#000",
                  shadowOpacity: 0.2,
                  shadowRadius: 8,
                  shadowOffset: { width: 0, height: 2 },
                  elevation: 4,
                }}
              >
                <ArrowLeft size={20} color="#1F2937" />
              </TouchableOpacity>

              <View style={{ flexDirection: "row", gap: 8 }}>
                <TouchableOpacity
                  onPress={handleSaveToggle}
                  style={{
                    width: 40,
                    height: 40,
                    borderRadius: 20,
                    backgroundColor: "rgba(255, 255, 255, 0.95)",
                    alignItems: "center",
                    justifyContent: "center",
                    shadowColor: "#000",
                    shadowOpacity: 0.2,
                    shadowRadius: 8,
                    shadowOffset: { width: 0, height: 2 },
                    elevation: 4,
                  }}
                >
                  {isSaved ? (
                    <BookmarkCheck size={20} color="#70AD47" />
                  ) : (
                    <Bookmark size={20} color="#6B7280" />
                  )}
                </TouchableOpacity>

                <TouchableOpacity
                  onPress={handleFavoriteToggle}
                  style={{
                    width: 40,
                    height: 40,
                    borderRadius: 20,
                    backgroundColor: "rgba(255, 255, 255, 0.95)",
                    alignItems: "center",
                    justifyContent: "center",
                    shadowColor: "#000",
                    shadowOpacity: 0.2,
                    shadowRadius: 8,
                    shadowOffset: { width: 0, height: 2 },
                    elevation: 4,
                  }}
                >
                  <Heart
                    size={20}
                    color={isFavorite ? "#FF6B6B" : "#6B7280"}
                    fill={isFavorite ? "#FF6B6B" : "transparent"}
                  />
                </TouchableOpacity>

                <TouchableOpacity
                  onPress={handleShare}
                  style={{
                    width: 40,
                    height: 40,
                    borderRadius: 20,
                    backgroundColor: "rgba(255, 255, 255, 0.95)",
                    alignItems: "center",
                    justifyContent: "center",
                    shadowColor: "#000",
                    shadowOpacity: 0.2,
                    shadowRadius: 8,
                    shadowOffset: { width: 0, height: 2 },
                    elevation: 4,
                  }}
                >
                  <Share2 size={20} color="#6B7280" />
                </TouchableOpacity>
              </View>
            </View>
          </SafeAreaView>
        </View>

        {/* Content */}
        <View
          style={{
            backgroundColor: colors.background,
            borderTopLeftRadius: 32,
            borderTopRightRadius: 32,
            marginTop: -32,
            paddingTop: 24,
          }}
        >
          {/* Meta Info Row - with Health Score */}
          <View style={{ paddingHorizontal: 20, marginBottom: 20 }}>
            <View
              style={{
                flexDirection: "row",
                justifyContent: "space-between",
                alignItems: "center",
                gap: 8,
              }}
            >
              <View style={{ flex: 1 }}>
                <MetaItem
                  icon={Clock}
                  value={`${recipe.readyInMinutes}m`}
                  label="Prep & Cook Time"
                  color="#70AD47"
                />
              </View>
              <View style={{ flex: 1 }}>
                <MetaItem
                  icon={Users}
                  value={`${recipe.servings}`}
                  label="Servings"
                  color="#4363daff"
                />
              </View>
              <View style={{ flex: 1 }}>
                <MetaItem
                  icon={Flame}
                  value={difficulty}
                  label="Difficulty"
                  color="#c96f25ff"
                />
              </View>
              {recipe.healthScore && (
                <View style={{ flex: 1 }}>
                  <MetaItem
                    icon={Heart}
                    value={`${recipe.healthScore}`}
                    label="Health Score"
                    color="#FF6B6B"
                  />
                </View>
              )}
            </View>
          </View>

          {/* Description */}
          {recipe.summary && (
            <View style={{ paddingHorizontal: 20, marginBottom: 24 }}>
              <Text
                style={{
                  fontSize: 15,
                  color: colors.textSecondary,
                  lineHeight: 24,
                  textAlign: "justify",
                }}
              >
                {recipe.summary.replace(/<[^>]*>/g, "")}
              </Text>
            </View>
          )}

          {/* Tabs */}
          <View
            style={{
              paddingHorizontal: 20,
              marginBottom: 20,
            }}
          >
            <View
              style={{
                backgroundColor: colors.cardBg,
                borderRadius: 16,
                padding: 4,
                flexDirection: "row",
                shadowColor: "#000",
                shadowOpacity: 0.05,
                shadowRadius: 8,
                shadowOffset: { width: 0, height: 2 },
                elevation: 2,
              }}
            >
              <TouchableOpacity
                onPress={() => handleTabChange("ingredients")}
                style={{
                  flex: 1,
                  paddingVertical: 12,
                  borderRadius: 12,
                  alignItems: "center",
                  backgroundColor:
                    activeTab === "ingredients"
                      ? colors.primary
                      : "transparent",
                  shadowColor:
                    activeTab === "ingredients"
                      ? colors.primary
                      : "transparent",
                  shadowOpacity: activeTab === "ingredients" ? 0.3 : 0,
                  shadowRadius: 8,
                  shadowOffset: { width: 0, height: 2 },
                  elevation: activeTab === "ingredients" ? 3 : 0,
                }}
              >
                <Text
                  style={{
                    fontSize: 16,
                    fontWeight: "600",
                    color:
                      activeTab === "ingredients"
                        ? "#FFFFFF"
                        : colors.textSecondary,
                  }}
                >
                  Ingredients
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                onPress={() => handleTabChange("instructions")}
                style={{
                  flex: 1,
                  paddingVertical: 12,
                  borderRadius: 12,
                  alignItems: "center",
                  backgroundColor:
                    activeTab === "instructions"
                      ? colors.primary
                      : "transparent",
                  shadowColor:
                    activeTab === "instructions"
                      ? colors.primary
                      : "transparent",
                  shadowOpacity: activeTab === "instructions" ? 0.3 : 0,
                  shadowRadius: 8,
                  shadowOffset: { width: 0, height: 2 },
                  elevation: activeTab === "instructions" ? 3 : 0,
                }}
              >
                <Text
                  style={{
                    fontSize: 16,
                    fontWeight: "600",
                    color:
                      activeTab === "instructions"
                        ? "#FFFFFF"
                        : colors.textSecondary,
                  }}
                >
                  Instructions
                </Text>
              </TouchableOpacity>
            </View>
          </View>

          {/* Tab Content with Slide Animation */}
          <Animated.View
            style={{
              transform: [{ translateX: slideAnim }],
              opacity: fadeAnim,
            }}
          >
            {activeTab === "ingredients" ? (
              <View style={{ paddingHorizontal: 20, gap: 12 }}>
                {recipe.extendedIngredients &&
                recipe.extendedIngredients.length > 0 ? (
                  recipe.extendedIngredients.map((ingredient, index) => (
                    <View
                      key={index}
                      style={{
                        flexDirection: "row",
                        alignItems: "center",
                        gap: 12,
                        backgroundColor: colors.cardBg,
                        padding: 16,
                        borderRadius: 16,
                        shadowColor: "#000",
                        shadowOpacity: 0.05,
                        shadowRadius: 8,
                        shadowOffset: { width: 0, height: 2 },
                        elevation: 2,
                        borderWidth: 1,
                        borderColor: colors.border || "#F3F4F6",
                      }}
                    >
                      <View
                        style={{
                          width: 8,
                          height: 8,
                          borderRadius: 4,
                          backgroundColor: colors.primary,
                        }}
                      />
                      <Text
                        style={{
                          flex: 1,
                          fontSize: 15,
                          color: colors.textPrimary,
                        }}
                      >
                        {ingredient.original}
                      </Text>
                    </View>
                  ))
                ) : (
                  <Text style={{ fontSize: 14, color: colors.textSecondary }}>
                    No ingredients available
                  </Text>
                )}
              </View>
            ) : (
              <View style={{ paddingHorizontal: 20, gap: 16 }}>
                {recipe.analyzedInstructions &&
                recipe.analyzedInstructions.length > 0 &&
                recipe.analyzedInstructions[0].steps ? (
                  recipe.analyzedInstructions[0].steps.map((step, index) => (
                    <View
                      key={index}
                      style={{
                        flexDirection: "row",
                        gap: 16,
                        backgroundColor: colors.cardBg,
                        padding: 16,
                        borderRadius: 16,
                        shadowColor: "#000",
                        shadowOpacity: 0.05,
                        shadowRadius: 8,
                        shadowOffset: { width: 0, height: 2 },
                        elevation: 2,
                        borderWidth: 1,
                        borderColor: colors.border || "#F3F4F6",
                      }}
                    >
                      <View
                        style={{
                          width: 32,
                          height: 32,
                          borderRadius: 16,
                          backgroundColor: `${colors.primary}10`,
                          alignItems: "center",
                          justifyContent: "center",
                          borderWidth: 1,
                          borderColor: `${colors.primary}20`,
                        }}
                      >
                        <Text
                          style={{
                            fontSize: 14,
                            fontWeight: "600",
                            color: colors.primary,
                          }}
                        >
                          {step.number}
                        </Text>
                      </View>
                      <Text
                        style={{
                          flex: 1,
                          fontSize: 15,
                          color: colors.textPrimary,
                          lineHeight: 22,
                        }}
                      >
                        {step.step}
                      </Text>
                    </View>
                  ))
                ) : recipe.instructions ? (
                  <Text
                    style={{
                      fontSize: 15,
                      color: colors.textPrimary,
                      lineHeight: 22,
                    }}
                  >
                    {recipe.instructions.replace(/<[^>]*>/g, "")}
                  </Text>
                ) : (
                  <Text style={{ fontSize: 14, color: colors.textSecondary }}>
                    No instructions available
                  </Text>
                )}
              </View>
            )}
          </Animated.View>

          {/* Padding for bottom button */}
          <View style={{ height: 100 }} />
        </View>
      </Animated.ScrollView>

      {/* Start Cooking / Mark as Cooked Button */}
      <View
        style={{
          position: "absolute",
          bottom: bottom || 10,
          left: 20,
          right: 20,
          backgroundColor: "transparent",
        }}
      >
        <TouchableOpacity
          onPress={handleMarkAsCooked}
          style={{
            backgroundColor: isCooked ? "#10B981" : colors.primary,
            paddingVertical: 16,
            borderRadius: 16,
            flexDirection: "row",
            alignItems: "center",
            justifyContent: "center",
            gap: 10,
            shadowColor: isCooked ? "#10B981" : colors.primary,
            shadowOpacity: 0.4,
            shadowRadius: 12,
            shadowOffset: { width: 0, height: 4 },
            elevation: 6,
          }}
          activeOpacity={0.8}
        >
          <ChefHat size={22} color="#FFFFFF" />
          <Text
            style={{
              fontSize: 17,
              fontWeight: "700",
              color: "#FFFFFF",
            }}
          >
            {isCooked ? "Cooked! âœ“" : "Mark as Cooked"}
          </Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}
