// lib/firebase.ts
/**
 * Firebase Configuration & Initialization with AsyncStorage Persistence
 *
 * UPDATED: Added AsyncStorage persistence for auth state
 */

import { initializeApp, getApps, FirebaseApp } from "firebase/app";
import {
  initializeAuth,
  getReactNativePersistence,
  getAuth,
  Auth,
} from "firebase/auth";
import { getFirestore, Firestore } from "firebase/firestore";
import AsyncStorage from "@react-native-async-storage/async-storage";

/**
 * Firebase configuration
 */
const firebaseConfig = {
  apiKey: process.env.EXPO_PUBLIC_FIREBASE_API_KEY || "YOUR_API_KEY_HERE",
  authDomain:
    process.env.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN ||
    "your-project.firebaseapp.com",
  projectId: process.env.EXPO_PUBLIC_FIREBASE_PROJECT_ID || "your-project-id",
  storageBucket:
    process.env.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET ||
    "your-project.appspot.com",
  messagingSenderId:
    process.env.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || "123456789",
  appId:
    process.env.EXPO_PUBLIC_FIREBASE_APP_ID || "1:123456789:web:abcdef123456",
};

/**
 * Validate Firebase configuration
 */
if (
  firebaseConfig.apiKey === "YOUR_API_KEY_HERE" ||
  firebaseConfig.apiKey.includes("YOUR_") ||
  firebaseConfig.projectId === "your-project-id"
) {
  console.error("ğŸ”¥ FIREBASE CONFIGURATION ERROR!");
  console.error("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.error("You need to update your Firebase config in lib/firebase.ts");
  console.error("");
  console.error("HOW TO FIX:");
  console.error("1. Go to https://console.firebase.google.com/");
  console.error("2. Select or create your MyChef project");
  console.error("3. Click Settings (âš™ï¸) â†’ Project Settings");
  console.error("4. Scroll to 'Your apps' â†’ Click your web app");
  console.error("5. Copy the config values");
  console.error("6. Replace the values in lib/firebase.ts");
  console.error("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

  throw new Error(
    "Firebase configuration not found. Please update lib/firebase.ts with your Firebase project credentials."
  );
}

console.log("ğŸ”¥ Firebase initializing with project:", firebaseConfig.projectId);

/**
 * Initialize Firebase
 */
let firebaseApp: FirebaseApp;

if (getApps().length === 0) {
  firebaseApp = initializeApp(firebaseConfig);
  console.log("âœ… Firebase initialized successfully!");
} else {
  firebaseApp = getApps()[0];
  console.log("âœ… Firebase already initialized");
}

/**
 * Firebase Authentication instance with AsyncStorage persistence
 * This ensures users stay logged in after closing the app
 */
let auth: Auth;
try {
  auth = initializeAuth(firebaseApp, {
    persistence: getReactNativePersistence(AsyncStorage),
  });
  console.log("âœ… Firebase Auth initialized with AsyncStorage persistence");
} catch (error: any) {
  // If auth is already initialized, get the existing instance
  if (error.code === "auth/already-initialized") {
    auth = getAuth(firebaseApp);
    console.log("âœ… Firebase Auth already initialized");
  } else {
    console.error("âŒ Firebase Auth initialization error:", error);
    throw error;
  }
}

/**
 * Firestore Database instance
 */
export const db: Firestore = getFirestore(firebaseApp);
console.log("âœ… Firestore initialized");

/**
 * Export instances
 */
export { firebaseApp, auth };
